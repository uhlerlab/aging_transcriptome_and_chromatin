---
title: "04_TF-expression"
author: "Jana Braunger"
date: '2022-05-26'
output: BiocStyle::html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
BiocStyle::html_document 

dir <- "/Users/janabraunger/Documents/Studium/Master/Boston/Masterarbeit/"
figdir = paste0(dir, "Figures/TF_expr/")
if(!dir.exists(figdir)) dir.create(figdir)
knitr::opts_chunk$set(dev = c("png", "pdf"), fig.path = figdir)

library(showtext)
font_add("Arial", "/Library/Fonts/Arial.ttf")
showtext_auto()
```

```{r load_libraries, message = FALSE, warning = FALSE}
library(tidyverse)
library(magrittr)
library(ggbeeswarm)
```

# Load data
## Variance-stabilized transformed expression values for all genes in all individuals
```{r}
#counts <- read.delim(paste0(dir, "Data/count_data.csv"), sep = ",")
counts <- read.delim(paste0(dir, "Data/vst_counts.csv"), sep = ",")
#mean_counts <- read.delim(paste0(dir, "Data/mean_counts.csv"), sep = ",")
head(counts)
```

## TF groups from the Steiner trees
```{r}
pcst_groups <- read.delim(paste0(dir, "Data/specific_TFs_targets.csv"), sep = ",")  %>%
  mutate(net = factor(net, levels = c('young_net', 'middle_net', 'old_net', 'shared')))
head(pcst_groups)
```


# PCST groups
```{r}
plot_TF_expression <- function(TFs){
  TF_expr <- filter(counts, gene %in% TFs) %>%
    # if two ensembl ids correspond to the same TF take the mean count
    group_by(gene, names, Age, age_group) %>%
    summarize(counts = mean(counts)) 
  
  ggplot(TF_expr, aes(x = Age, y = counts, group = gene, color = gene)) +
    geom_point(color = 'grey') +
    theme_bw() + 
    facet_wrap(~gene, scales = "free_y") +
    theme(legend.position="none") + 
    theme(text = element_text(size = 13),
          strip.text.x = element_text(size = 16)) +
    xlab("Age") + 
    ylab("Normalized expression") +
    geom_smooth(color = "brown")
}

plot_TF_mean_expression <- function(TFs){
  TF_expr <- filter(counts, gene %in% TFs) %>%
    # if two ensembl ids correspond to the same gene take the mean count
    group_by(gene, names, Age, age_group) %>%
    summarize(counts = mean(counts)) 
  
  ggplot(TF_expr, aes(x = age_group, y = counts, group = gene, color = gene)) +
    geom_point(color = 'grey', alpha = 0.4) +
    #geom_beeswarm(color = 'grey', cex = 3) +
    theme_bw() + 
    facet_wrap(~gene, scales = "free_y") +
    theme(legend.position="none") + 
    theme(text = element_text(size = 13),
          strip.text.x = element_text(size = 15),
          axis.text.x = element_text(angle = 90)) +
    xlab("Age") + 
    ylab("Normalized expression") +
    geom_line(stat = "summary", fun = "mean", colour = "brown", size = 1, aes(group = 1))
}

TF_variability <- function(TFs){
  TF_expr <- filter(counts, gene %in% TFs) %>%
    # if two ensembl ids correspond to the same TF take the mean count
    group_by(gene, names, Age, age_group) %>%
    summarize(counts = mean(counts)) %>%
    ungroup() %>%
    # get median expression per age group
    group_by(gene, age_group) %>%
    summarize(median = median(counts)) %>%
    ungroup() %>%
    # calculate variance per TF
    group_by(gene) %>%
    summarize(variance = var(median)) %>%
    # order TFs from highest to lowest variance
    arrange(desc(variance))
  return(TF_expr)
}
```


## Shared TFs
```{r shared_TFs, fig.height=4}
TFs <- unique(filter(pcst_groups, net == "shared")$TF)
plot_TF_mean_expression(TFs) +facet_wrap(~gene, scales = "free_y", nrow = 3)
TF_variability(TFs)
```

## Old-specific TFs
```{r old_TFs, fig.height=4}
TFs <- unique(filter(pcst_groups, net == "old_net")$TF)

plot_TF_mean_expression(TFs) +facet_wrap(~gene, scales = "free_y", nrow = 3)
TF_variability(TFs)
```

## Young-specific TFs
```{r young_TFs, fig.height=4}
TFs <- unique(filter(pcst_groups, net == "young_net")$TF)
plot_TF_mean_expression(TFs)+facet_wrap(~gene, scales = "free_y", nrow = 3)
TF_variability(TFs)
```


## Middle network specific TFs
```{r middle_TFs, , fig.height=5}
TFs <-  unique(filter(pcst_groups, net == "middle_net")$TF)
plot_TF_mean_expression(TFs) +facet_wrap(~gene, scales = "free_y", ncol = 7)
```


## Differentially expressed TFs
```{r}
TF_targets <- read.delim(paste0(dir, "Data/tf-target-information.txt"))
p_0.05 <- read.delim(paste0(dir, "Data/DE_var_p_n_200.csv"), sep = ",")

DE_TFs <- filter(p_0.05, gene %in% TF_targets$TF) %>%
  filter(transition != "fc_61-85_86-96")
head(DE_TFs)
dim(DE_TFs)
```


```{r DE_TFs_mean}
plot_TF_mean_expression(unique(DE_TFs$gene))
```

## MAZ, FLI1, ZNF384
```{r maz_fli1_znf384, fig.height=4}
TFs <-  c("MAZ", "FLI1", "ZNF384")
plot_TF_mean_expression(TFs) + facet_wrap(~gene, scales = "free_y", ncol = 3)
```


# Expression trajectories for DE genes
## Age group 1 vs 2
```{r g1-2, fig.height = 2.5}
genes <-  c("PRXL2B", "MOAP1", "MYO19", "GMPR2", "TRIM39")
plot_TF_mean_expression(genes) + 
  facet_wrap(~gene, scales = "free_y", nrow = 1)
```

## Age group 2 vs 3
```{r g2-3, fig.height = 2.5}
genes <-  c("SKA1", "FLOT1", "PRXL2B", "RRN3", "MOAP1")
plot_TF_mean_expression(genes) + 
  facet_wrap(~gene, scales = "free_y", nrow = 1)
```

## Age group 3 vs 4
```{r g3-4, fig.height = 2.5}
genes <-  c("MYO19", "RING1", "PRXL2B", "FOXS1", "LEP")
plot_TF_mean_expression(genes) + 
  facet_wrap(~gene, scales = "free_y", nrow = 1)
```

## Age group 4 vs 5 
```{r g4-5, fig.height = 2.5}
genes <-  c("MYO19", "FLOT1", "RING1", "TNXB", "PRXL2B")
plot_TF_mean_expression(genes) + 
  facet_wrap(~gene, scales = "free_y", nrow = 1)
```


# Significant bridge TFs
## Steiner network S1
```{r expr_S1_TFs, fig.height = 2.5}
genes <-  c("CEBPB", "FLI1", "MAZ", "SUMO2", "AHR", "EP300")
plot_TF_mean_expression(genes) + 
  facet_wrap(~gene, scales = "free_y", nrow = 1)
```

## Steiner network S3
```{r expr_S3_TFs, fig.height = 6}
genes <-  c('E2F1', 'KDM4C', 'POLR2A', 'HOXA6', 'HDAC1', 'TAF3', 'GTF2B',
                'RBBP5', 'NOTCH1', 'GABPA', 'MNT', 'BRD2', 'KAT5', 'BMI1', 'ZNF384')
plot_TF_mean_expression(genes) + 
  facet_wrap(~gene, scales = "free_y", ncol = 6)
```

## Selected genes
```{r lasso_expr1, fig.height = 4}
genes <-  c('RILP', 'CD300C', 'MYCL', 'MROH7', 'ZNF534')
plot_TF_expression(genes) + 
  facet_wrap(~gene, scales = "free_y", ncol = 6)
```
```{r lasso_expr2, fig.height = 4}
genes <-  c('ILKAP', 'NUDT19', 'RILP', 'NEFH', 'ITPRIPL2')
plot_TF_expression(genes) + 
  facet_wrap(~gene, scales = "free_y", ncol = 6)
```
