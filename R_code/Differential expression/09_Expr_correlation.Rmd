---
title: "09_Expr_correlation"
author: "Jana"
date: "2022-11-09"
output: BiocStyle::html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
BiocStyle::html_document 

dir <- "/Users/janabraunger/Documents/Studium/Master/Boston/Masterarbeit/"
figdir = paste0(dir, "Figures/Expr_correaltion/")
if(!dir.exists(figdir)) dir.create(figdir)
knitr::opts_chunk$set(dev = c("png", "pdf"), fig.path = figdir)

set.seed(202210)
library(showtext)
font_add("Arial", "/Library/Fonts/Arial.ttf")
showtext_auto()
```

```{r load_libraries, message = FALSE, warning = FALSE}
library(tidyverse)
library(magrittr)
library(pheatmap)
```

# Load data
## Diff map for old down DE targets and young up DE targets
```{r}
#diff_map <- read.delim(paste0(dir, "Data/difference_maps/diff_DE_DDX5_old.csv"), sep = ",")
diff_map <- read.delim(paste0(dir, "Data/difference_maps/diff_DE_down_old.csv"), sep = ",")
colnames(diff_map) <- str_replace(colnames(diff_map), "\\.", "-")
```

```{r}
diff_map_young <- read.delim(paste0(dir, "Data/difference_maps/diff_DE_up_young.csv"), sep = ",")
colnames(diff_map_young) <- str_replace(colnames(diff_map_young), "\\.", "-")
```


## FPKM expression values for all DE genes in all individuals
```{r}
counts_old <- read.delim(paste0(dir, "Data/count_data.csv"), sep = ",") %>%
  subset(select = c(gene, names, counts, Age)) %>%
  filter(gene %in% colnames(diff_map)) %>%
  group_by(gene, names, Age) %>%
  summarize(counts = mean(counts)) %>% # mean counts in case multiple ensembl id belong to one gene symbol
  spread(key = gene, value = counts) %>%
  column_to_rownames(var = 'names')
counts_old[1:5, 1:5]

counts_young <- read.delim(paste0(dir, "Data/count_data.csv"), sep = ",") %>%
  subset(select = c(gene, names, counts, Age)) %>%
  filter(gene %in% colnames(diff_map_young)) %>%
  group_by(gene, names, Age) %>%
  summarize(counts = mean(counts)) %>% # mean counts in case multiple ensembl id belong to one gene symbol
  spread(key = gene, value = counts) %>%
  column_to_rownames(var = 'names')
```


# Expression Correlation 
## Correlation Map over all individuals
```{r corr_map, fig.height = 7, fig.width = 7}
cor_map <- cor(counts_old[, 2:ncol(counts_old)])
# order rows and cols as in diff map
cor_map <- cor_map[colnames(diff_map), colnames(diff_map)]

pheatmap(cor_map, cluster_cols = F, cluster_rows = F)#, show_rownames = F, show_colnames = F)
```

```{r corr_per_group}
corr_long <- data.frame(cor_map, row.names = colnames(diff_map)) %>% 
  rownames_to_column(var = 'target1') %>%
  gather(key = 'target2', value = 'cor', -target1) 

intermingling_anno <- data.frame('value' = c(0, 1, 2, 3), 
                                 'intermingling' = c('none', 'young', 'old', 'shared'))

diff_cor <- diff_map %>%
  mutate(target1 = colnames(diff_map)) %>%
  gather(key = 'target2', value = 'value', -target1) %>%
  left_join(corr_long) %>%
  filter(target1 != target2) %>%
  left_join(intermingling_anno) %>%
  mutate(intermingling = factor(intermingling, levels = c('none', 'young', 'old', 'shared')))

ggplot(diff_cor, aes(x = intermingling, y = cor, group = intermingling, fill = intermingling)) +
  geom_boxplot() + 
  theme_bw() +
  ylab('correlation') + 
  theme(text = element_text(size = 15))
```


## Comparison of correlation in young and old individuals 
```{r}
# define function to get the gene correlation for a certain age group
get_cor_map <- function(counts, age_list){
  cor(filter(counts, Age %in% age_list)[, 2:ncol(counts)]) %>%
    data.frame(row.names = colnames(counts)[2:ncol(counts)]) %>% 
    rownames_to_column(var = 'target1') %>%
    gather(key = 'target2', value = 'cor', -target1) %>%
    mutate(target2 = gsub("\\.", "-", target2))
}
```

```{r}
diff_corr <- diff_map %>%
  mutate(target1 = colnames(diff_map)) %>%
  gather(key = 'target2', value = 'value', -target1) %>%
  filter(value == 2) %>%
  left_join(dplyr::rename(get_cor_map(counts_old,  seq(1, 15)), group1 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_old,  seq(16, 26)), group2 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_old,  seq(27, 60)), group3 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_old, seq(61, 84)), group4 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_old,  seq(85, 96)), group5 = cor)) %>%
  gather(key = "group", value = "cor", -c(target1, target2, value))

ggplot(diff_corr, aes(x = group, y = cor)) +
  geom_boxplot() +
  theme_bw() +
  ylab('correlation') +
  xlab('age groups')
```

```{r}
diff_corr <- diff_map_young %>%
  mutate(target1 = colnames(diff_map_young)) %>%
  gather(key = 'target2', value = 'value', -target1) %>%
  filter(value == 2) %>%
  left_join(dplyr::rename(get_cor_map(counts_young,  seq(1, 15)), group1 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_young,  seq(16, 26)), group2 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_young,  seq(27, 60)), group3 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_young,  seq(61, 84)), group4 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_young,  seq(85, 96)), group5 = cor)) %>%
  gather(key = "group", value = "cor", -c(target1, target2, value))

ggplot(diff_corr, aes(x = group, y = cor)) +
  geom_boxplot() +
  theme_bw() +
  ylab('correlation') +
  xlab('age groups')
```


# FLI1, MAZ, ZNF384
```{r}
diff_map <- read.delim(paste0(dir, "Data/difference_maps/diff_map_FLI1.csv"), sep = ",")
#diff_map <- read.delim(paste0(dir, "Data/difference_maps/diff_map_ZNF384.csv"), sep = ",")

counts<- read.delim(paste0(dir, "Data/count_data.csv"), sep = ",") %>%
  subset(select = c(gene, names, counts, Age)) %>%
  group_by(gene, names, Age) %>%
  summarize(counts = mean(counts))  # mean counts in case multiple ensembl id belong to one gene symbol
```


## Example for a node with only young-specific interactions
```{r}
selected_node = "TOP2A"
diff_map_sub = filter(diff_map, target1 == selected_node)
counts_sub = counts %>%
  filter(gene %in% c(diff_map_sub$target1, diff_map_sub$target2)) %>%
  spread(key = gene, value = counts) %>%
  column_to_rownames(var = 'names')
correlations = diff_map_sub %>%
  left_join(dplyr::rename(get_cor_map(counts_sub, seq(1, 15)), group1 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_sub, seq(16, 26)), group2 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_sub, seq(27, 60)), group3 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_sub, seq(61, 84)), group4 = cor)) %>%
  left_join(dplyr::rename(get_cor_map(counts_sub, seq(85, 96)), group5 = cor)) %>%
  gather(key = "group", value = "cor", -c(target1, target2, value)) %>%
  mutate(value = factor(value, levels = c('young', 'old'))) %>%
  filter(group %in% c('group1', 'group5'))

ggplot(correlations, aes(x = group, y = cor)) + 
  geom_bar(stat = "identity") +
  facet_wrap(~target2) +
  theme_bw()
ggplot(correlations, aes(x = group, y = cor)) + 
  geom_boxplot() +
  theme_bw() + 
  ylab('gene expression correlation') + 
  xlab('age groups') + 
  ggtitle(selected_node) +
  #theme(plot.title = element_text(colour = "blue")) +
  theme(text = element_text(size = 20)) +
  facet_wrap(~value)
```




# Variability of DE genes
## Load data
```{r}
# median FPKM values for each gene in each age group
counts <- read.delim(paste0(dir, "Data/count_data.csv"), sep = ",") %>%
  subset(select = c(gene, age_group, counts)) %>%
  group_by(gene, age_group) %>%
  summarize(counts = median(counts)) %>%
  ungroup() %>%
  mutate(counts = log2(counts))
head(counts)
```

```{r}
# DE genes
age <- data.frame('transition' = c('fc_16-26_27-60', 'fc_61-85_86-96'), 
                  'age' = c('young', 'old'))
DE_genes <- read.delim(paste0(dir, "Data/DE_var_p_n_200.csv"), sep = ",") %>%
  inner_join(age) 

# intermingling genes
young <- data.frame('gene' = c('NIPAL3','MAN1C1','CTSK','NPR1','GATAD2B','SCAMP3',
 'KISS1','KANSL1L','ITPR1','PLXNB1','SLC38A3','APOD','CYP3A5','OSR2','UBR5','CTHRC1',
 'PCBD1','ZNF503','PSD','MAP3K12','SELPLG','ZFP36L1','BMF','CRISPLD2','CACNG4',
 'OR10H1','ETHE1','ZNF284','DACT3','SLC6A16','KCNB1'),
 'intermingling' = 'young_intermingling')
old <- data.frame('gene' = c('HJURP','MCM2','CDC25C','C7orf50','CHST12',
 'AP1S1','PBK','ESCO2','TONSL','RECQL4','ENDOG','IER5L','SLC2A6','SAC3D1','ZNHIT2',
 'CDCA5','LRFN4','RELT','CDCA3','ESPL1','DLGAP5','XRCC3','SIVA1','BUB1B','OIP5',
 'NUSAP1','CSPG4','METRN','CHTF18','TELO2','NUBP2','SLC9A3R2','CCNF','PKMYT1',
 'PLK1','SHCBP1','GINS2','CDT1','HIC1','FAM83G','TOP2A','KIF18B','TK1','BIRC5',
 'CEP131','SLC25A10','RAC3','NDC80','RNF126','SBNO2','NDUFS7','DOHH','UHRF1',
 'ALDH16A1','MCM8','E2F1','SCAND1','UBE2C','KCNG1','LIME1','RTEL1-TNFRSF6B','RGS19'), 
 'intermingling' = 'old_intermingling')
DE_genes %<>% left_join(bind_rows(young, old)) %>%
  mutate(intermingling = replace_na(intermingling, 'other'))
head(DE_genes)
```


## Log2 Foldchange of intermingling vs. others
```{r}
var <- counts %>% group_by(gene) %>%
  summarize(var = var(counts)) %>%
  right_join(DE_genes) %>%
  mutate(age = factor(age, levels = c('young', 'old'))) %>%
  mutate(intermingling = factor(intermingling, levels = c('young_intermingling', 'old_intermingling', 'other')))

ggplot(var, aes(x = intermingling, y = abs_log2_fc)) +
  geom_boxplot() +
  facet_wrap(~age, scale = "free") +
  ylab("abs log2 foldchange")  + 
  theme_bw() +
  theme(text = element_text(size = 15)) +
  ylim(0, 10)
```



